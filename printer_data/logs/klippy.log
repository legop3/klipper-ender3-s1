===== Config file =====
[exclude_object]

[gcode_macro BED_MESH_CALIBRATE]
rename_existing = _BED_MESH_CALIBRATE
gcode = 
	
	{% set all_points = printer.exclude_object.objects | map(attribute='polygon') | sum(start=[]) %}
	{% set bed_mesh_min = printer.configfile.settings.bed_mesh.mesh_min %}
	{% set bed_mesh_max = printer.configfile.settings.bed_mesh.mesh_max %}
	{% set probe_count = printer.configfile.settings.bed_mesh.probe_count %}
	{% set kamp_settings = printer["gcode_macro _KAMP_Settings"] %}
	{% set verbose_enable = kamp_settings.verbose_enable | abs %}
	{% set probe_dock_enable = kamp_settings.probe_dock_enable | abs %}
	{% set attach_macro = kamp_settings.attach_macro | string %}
	{% set detach_macro = kamp_settings.detach_macro | string %}
	{% set mesh_margin = kamp_settings.mesh_margin | float %}
	{% set fuzz_amount = kamp_settings.fuzz_amount | float %}
	{% set probe_count = probe_count if probe_count|length > 1 else probe_count * 2  %}
	{% set max_probe_point_distance_x = ( bed_mesh_max[0] - bed_mesh_min[0] ) / (probe_count[0] - 1)  %}
	{% set max_probe_point_distance_y = ( bed_mesh_max[1] - bed_mesh_min[1] ) / (probe_count[1] - 1)  %}
	{% set x_min = all_points | map(attribute=0) | min | default(bed_mesh_min[0]) %}
	{% set y_min = all_points | map(attribute=1) | min | default(bed_mesh_min[1]) %}
	{% set x_max = all_points | map(attribute=0) | max | default(bed_mesh_max[0]) %}
	{% set y_max = all_points | map(attribute=1) | max | default(bed_mesh_max[1]) %}
	
	{% set fuzz_range = range((0) | int, (fuzz_amount * 100) | int + 1) %}
	{% set adapted_x_min = x_min - mesh_margin - (fuzz_range | random / 100.0) %}
	{% set adapted_y_min = y_min - mesh_margin - (fuzz_range | random / 100.0) %}
	{% set adapted_x_max = x_max + mesh_margin + (fuzz_range | random / 100.0) %}
	{% set adapted_y_max = y_max + mesh_margin + (fuzz_range | random / 100.0) %}
	
	{% set adapted_x_min = [adapted_x_min , bed_mesh_min[0]] | max %}
	{% set adapted_y_min = [adapted_y_min , bed_mesh_min[1]] | max %}
	{% set adapted_x_max = [adapted_x_max , bed_mesh_max[0]] | min %}
	{% set adapted_y_max = [adapted_y_max , bed_mesh_max[1]] | min %}
	
	{% set points_x = (((adapted_x_max - adapted_x_min) / max_probe_point_distance_x) | round(method='ceil') | int) + 1 %}
	{% set points_y = (((adapted_y_max - adapted_y_min) / max_probe_point_distance_y) | round(method='ceil') | int) + 1 %}
	
	{% if (([points_x, points_y]|max) > 6) %}
	{% set algorithm = "bicubic" %}
	{% set min_points = 4 %}
	{% else %}
	{% set algorithm = "lagrange" %}
	{% set min_points = 3 %}
	{% endif %}
	
	{% set points_x = [points_x , min_points]|max %}
	{% set points_y = [points_y , min_points]|max %}
	{% set points_x = [points_x , probe_count[0]]|min %}
	{% set points_y = [points_y , probe_count[1]]|min %}
	
	{% if verbose_enable == True %}
	{% if printer.exclude_object.objects != [] %}
	
	{ action_respond_info( "Algorithm: {}.".format(
	(algorithm),
	)) }
	
	{ action_respond_info("Default probe count: {},{}.".format(
	(probe_count[0]),
	(probe_count[1]),
	)) }
	
	{ action_respond_info("Adapted probe count: {},{}.".format(
	(points_x),
	(points_y),
	)) }
	
	{action_respond_info("Default mesh bounds: {}, {}.".format(
	(bed_mesh_min[0],bed_mesh_min[1]),
	(bed_mesh_max[0],bed_mesh_max[1]),
	)) }
	
	{% if mesh_margin > 0 %}
	{action_respond_info("Mesh margin is {}, mesh bounds extended by {}mm.".format(
	(mesh_margin),
	(mesh_margin),
	)) }
	{% else %}
	{action_respond_info("Mesh margin is 0, margin not increased.")}
	{% endif %}
	
	{% if fuzz_amount > 0 %}
	{action_respond_info("Mesh point fuzzing enabled, points fuzzed up to {}mm.".format(
	(fuzz_amount),
	)) }
	{% else %}
	{action_respond_info("Fuzz amount is 0, mesh points not fuzzed.")}
	{% endif %}
	
	{ action_respond_info("Adapted mesh bounds: {}, {}.".format(
	(adapted_x_min, adapted_y_min),
	(adapted_x_max, adapted_y_max),
	)) }
	
	{action_respond_info("KAMP adjustments successful. Happy KAMPing!")}
	
	{% else %}
	
	{action_respond_info("No objects detected! Check your gcode and make sure that EXCLUDE_OBJECT_DEFINE is happening before BED_MESH_CALIBRATE is called. Defaulting to regular meshing.")}
	G4 P5000
	{% endif %}
	
	{% endif %}
	
	{% if probe_dock_enable == True %}
	{attach_macro}
	{% endif %}
	
	_BED_MESH_CALIBRATE mesh_min={adapted_x_min},{adapted_y_min} mesh_max={adapted_x_max},{adapted_y_max} ALGORITHM={algorithm} PROBE_COUNT={points_x},{points_y}
	
	{% if probe_dock_enable == True %}
	{detach_macro}
	{% endif %}

[gcode_macro _KAMP_Settings]
description = This macro contains all adjustable settings for KAMP
variable_verbose_enable = True
variable_mesh_margin = 0
variable_fuzz_amount = 0
variable_probe_dock_enable = False
variable_attach_macro = 'Attach_Probe'
variable_detach_macro = 'Dock_Probe'
variable_purge_height = 0.8
variable_tip_distance = 0
variable_purge_margin = 10
variable_purge_amount = 30
variable_flow_rate = 12
variable_smart_park_height = 10
gcode = 
	
	{action_respond_info(" Running the KAMP_Settings macro does nothing, it is only used for storing KAMP settings. ")}

[stepper_x]
step_pin = PC2
dir_pin = PB9
enable_pin = !PC3
microsteps = 16
rotation_distance = 40
endstop_pin = !PA5
position_endstop = -10
position_max = 235
position_min = -10
homing_speed = 50

[stepper_y]
step_pin = PB8
dir_pin = PB7
enable_pin = !PC3
microsteps = 16
rotation_distance = 40
endstop_pin = !PA6
position_endstop = -8
position_max = 225
position_min = -8
homing_speed = 50

[stepper_z]
step_pin = PB6
dir_pin = !PB5
enable_pin = !PC3
microsteps = 16
rotation_distance = 8
endstop_pin = probe:z_virtual_endstop
position_max = 270
position_min = -4

[extruder]
step_pin = PB4
dir_pin = PB3
enable_pin = !PC3
microsteps = 16
gear_ratio = 42:12
rotation_distance = 26.359
nozzle_diameter = 0.400
filament_diameter = 1.750
heater_pin = PA1
sensor_type = EPCOS 100K B57560G104F
sensor_pin = PC5
control = pid
pid_kp = 23.561
pid_ki = 1.208
pid_kd = 114.859
min_temp = 0
max_temp = 260
pressure_advance = 0.12

[heater_bed]
heater_pin = PA7
sensor_type = EPCOS 100K B57560G104F
sensor_pin = PC4
control = pid
pid_kp = 71.867
pid_ki = 1.536
pid_kd = 840.843
min_temp = 0
max_temp = 100

[heater_fan hotend_fan]
pin = PC0

[fan]
pin = PA0

[mcu]
serial = /dev/serial/by-id/usb-1a86_USB_Serial-if00-port0
restart_method = command

[printer]
kinematics = cartesian
max_velocity = 300
max_accel = 2000
max_z_velocity = 5
max_z_accel = 100

[bltouch]
sensor_pin = ^PC14
control_pin = PC13
x_offset = -31.8
y_offset = -40.5
probe_with_touch_mode = true
stow_on_each_sample = false
z_offset = 3.290

[bed_mesh]
speed = 120
mesh_min = 0, 0
mesh_max = 203.2, 184.5
probe_count = 5,5
algorithm = bicubic

[safe_z_home]
home_xy_position = 147, 154
speed = 75
z_hop = 10
z_hop_speed = 5

[filament_switch_sensor e0_sensor]
switch_pin = !PC15
pause_on_runout = true
runout_gcode = PAUSE

[pause_resume]
recover_velocity = 25

[bed_screws]
screw1 = 20, 29
screw2 = 195, 29
screw3 = 195, 198
screw4 = 20, 198

[virtual_sdcard]
path = ~/printer_data/gcodes

[display_status]

[respond]

[gcode_macro START_PRINT]
gcode = 
	
	RESPOND TYPE=error MSG='start_print ran'

[gcode_macro PAUSE]
description = Pause the actual running print
rename_existing = PAUSE_BASE
variable_extrude = 1.0
gcode = 
	
	{% set E = printer["gcode_macro PAUSE"].extrude|float %}
	
	
	{% set x_park = printer.toolhead.axis_maximum.x|float - 5.0 %}
	{% set y_park = printer.toolhead.axis_maximum.y|float - 5.0 %}
	
	{% set max_z = printer.toolhead.axis_maximum.z|float %}
	{% set act_z = printer.toolhead.position.z|float %}
	{% if act_z < (max_z - 2.0) %}
	{% set z_safe = 2.0 %}
	{% else %}
	{% set z_safe = max_z - act_z %}
	{% endif %}
	
	PAUSE_BASE
	G91
	{% if printer.extruder.can_extrude|lower == 'true' %}
	G1 E-{E} F2100
	{% else %}
	{action_respond_info("Extruder not hot enough")}
	{% endif %}
	{% if "xyz" in printer.toolhead.homed_axes %}
	G1 Z{z_safe} F900
	G90
	G1 X{x_park} Y{y_park} F6000
	{% else %}
	{action_respond_info("Printer not homed")}
	{% endif %}

[gcode_macro RESUME]
description = Resume the actual running print
rename_existing = RESUME_BASE
gcode = 
	
	{% set E = printer["gcode_macro PAUSE"].extrude|float %}
	
	{% if 'VELOCITY' in params|upper %}
	{% set get_params = ('VELOCITY=' + params.VELOCITY)  %}
	{%else %}
	{% set get_params = "" %}
	{% endif %}
	
	{% if printer.extruder.can_extrude|lower == 'true' %}
	G91
	G1 E{E} F2100
	{% else %}
	{action_respond_info("Extruder not hot enough")}
	{% endif %}
	RESUME_BASE {get_params}

[gcode_macro CANCEL_PRINT]
description = Cancel the actual running print
rename_existing = CANCEL_PRINT_BASE
gcode = 
	TURN_OFF_HEATERS
	CANCEL_PRINT_BASE

[bed_mesh default]
version = 1
points = 
	0.227500, 0.080000, 0.170000, 0.260000, 0.475000
	-0.045000, -0.030000, 0.032500, 0.090000, 0.280000
	-0.122500, -0.080000, -0.077500, 0.072500, 0.247500
	-0.107500, -0.092500, -0.027500, 0.037500, 0.202500
	-0.122500, -0.117500, -0.062500, 0.015000, 0.147500
x_count = 5
y_count = 5
mesh_x_pps = 2
mesh_y_pps = 2
algo = lagrange
tension = 0.2
min_x = 0.0
max_x = 203.2
min_y = 0.0
max_y = 184.47
=======================
Loaded MCU 'mcu' 106 commands (v0.12.0-111-g4f00f219 / gcc: (15:10.3-2021.07-4) 10.3.1 20210621 (release) binutils: (2.38-3ubuntu1+15build1) 2.38)
MCU 'mcu' config: ADC_MAX=4095 BUS_PINS_i2c1=PB6,PB7 BUS_PINS_i2c1a=PB8,PB9 BUS_PINS_i2c2=PB10,PB11 BUS_PINS_spi1=PA6,PA7,PA5 BUS_PINS_spi1a=PB4,PB5,PB3 BUS_PINS_spi2=PB14,PB15,PB13 BUS_PINS_spi3=PB4,PB5,PB3 CLOCK_FREQ=72000000 MCU=stm32f103xe PWM_MAX=255 RECEIVE_WINDOW=192 RESERVE_PINS_serial=PA10,PA9 SERIAL_BAUD=250000 STATS_SUMSQ_BASE=256 STEPPER_BOTH_EDGE=1
Configured MCU 'mcu' (1024 moves)
Args: ['/home/daniel/klipper/klippy/klippy.py', '/home/daniel/printer_data/config/printer.cfg', '-I', '/home/daniel/printer_data/comms/klippy.serial', '-l', '/home/daniel/printer_data/logs/klippy.log', '-a', '/home/daniel/printer_data/comms/klippy.sock']
Git version: 'v0.12.0-111-g4f00f219'
Branch: master
Remote: origin
Tracked URL: https://github.com/Klipper3d/klipper
CPU: 4 core Intel(R) Core(TM) i5-5200U CPU @ 2.20GHz
Python: '3.10.12 (main, Nov 20 2023, 15:14:05) [GCC 11.4.0]'
webhooks client 140194350988976: {'program': 'Moonraker', 'version': 'v0.8.0-311-g65a8271'}
=============== Log rollover at Fri Mar  8 00:00:00 2024 ===============
Stats 714283.5: gcodein=0  mcu: mcu_awake=0.012 mcu_task_avg=0.000031 mcu_task_stddev=0.000030 bytes_write=26541281 bytes_read=3978967 bytes_retransmit=9 bytes_invalid=0 send_seq=469105 receive_seq=469105 retransmit_seq=2 srtt=0.002 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=71999135 heater_bed: target=60 temp=59.9 pwm=0.382 sd_pos=5566244 sysload=1.94 cputime=1888.617 memavail=6332620 print_time=14470.738 buffer_time=2.304 print_stall=88 extruder: target=205 temp=204.7 pwm=0.393
Stats 714284.5: gcodein=0  mcu: mcu_awake=0.012 mcu_task_avg=0.000031 mcu_task_stddev=0.000030 bytes_write=26543284 bytes_read=3979250 bytes_retransmit=9 bytes_invalid=0 send_seq=469139 receive_seq=469139 retransmit_seq=2 srtt=0.003 rttvar=0.000 rto=0.025 ready_bytes=10 upcoming_bytes=0 freq=71999138 heater_bed: target=60 temp=60.0 pwm=0.185 sd_pos=5566608 sysload=1.94 cputime=1888.627 memavail=6311984 print_time=14471.737 buffer_time=2.302 print_stall=88 extruder: target=205 temp=204.8 pwm=0.393
Stats 714285.5: gcodein=0  mcu: mcu_awake=0.012 mcu_task_avg=0.000031 mcu_task_stddev=0.000030 bytes_write=26546220 bytes_read=3979622 bytes_retransmit=9 bytes_invalid=0 send_seq=469191 receive_seq=469191 retransmit_seq=2 srtt=0.003 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=71999138 heater_bed: target=60 temp=59.9 pwm=0.373 sd_pos=5567021 sysload=1.94 cputime=1888.637 memavail=6302040 print_time=14473.008 buffer_time=2.572 print_stall=88 extruder: target=205 temp=204.8 pwm=0.450
Stats 714286.5: gcodein=0  mcu: mcu_awake=0.012 mcu_task_avg=0.000031 mcu_task_stddev=0.000030 bytes_write=26549597 bytes_read=3980005 bytes_retransmit=9 bytes_invalid=0 send_seq=469248 receive_seq=469248 retransmit_seq=2 srtt=0.002 rttvar=0.000 rto=0.025 ready_bytes=8 upcoming_bytes=0 freq=71999137 heater_bed: target=60 temp=60.0 pwm=0.202 sd_pos=5567645 sysload=2.02 cputime=1888.647 memavail=6282844 print_time=14474.119 buffer_time=2.684 print_stall=88 extruder: target=205 temp=205.0 pwm=0.359
Stats 714287.5: gcodein=0  mcu: mcu_awake=0.017 mcu_task_avg=0.000033 mcu_task_stddev=0.000031 bytes_write=26551583 bytes_read=3980308 bytes_retransmit=9 bytes_invalid=0 send_seq=469283 receive_seq=469283 retransmit_seq=2 srtt=0.002 rttvar=0.000 rto=0.025 ready_bytes=43 upcoming_bytes=0 freq=71999137 heater_bed: target=60 temp=60.0 pwm=0.299 sd_pos=5567928 sysload=2.02 cputime=1888.656 memavail=6254692 print_time=14474.842 buffer_time=2.405 print_stall=88 extruder: target=205 temp=204.8 pwm=0.467
Stats 714288.5: gcodein=0  mcu: mcu_awake=0.017 mcu_task_avg=0.000033 mcu_task_stddev=0.000031 bytes_write=26554679 bytes_read=3980690 bytes_retransmit=9 bytes_invalid=0 send_seq=469337 receive_seq=469337 retransmit_seq=2 srtt=0.002 rttvar=0.000 rto=0.025 ready_bytes=8 upcoming_bytes=0 freq=71999138 heater_bed: target=60 temp=60.0 pwm=0.256 sd_pos=5568344 sysload=2.02 cputime=1888.668 memavail=6236576 print_time=14476.150 buffer_time=2.713 print_stall=88 extruder: target=205 temp=205.0 pwm=0.377
Stats 714289.5: gcodein=0  mcu: mcu_awake=0.017 mcu_task_avg=0.000033 mcu_task_stddev=0.000031 bytes_write=26558100 bytes_read=3981078 bytes_retransmit=9 bytes_invalid=0 send_seq=469395 receive_seq=469395 retransmit_seq=2 srtt=0.003 rttvar=0.000 rto=0.025 ready_bytes=47 upcoming_bytes=0 freq=71999138 heater_bed: target=60 temp=59.9 pwm=0.318 sd_pos=5568961 sysload=2.02 cputime=1888.681 memavail=6229488 print_time=14477.326 buffer_time=2.889 print_stall=88 extruder: target=205 temp=205.1 pwm=0.346
Stats 714290.5: gcodein=0  mcu: mcu_awake=0.017 mcu_task_avg=0.000033 mcu_task_stddev=0.000031 bytes_write=26560293 bytes_read=3981376 bytes_retransmit=9 bytes_invalid=0 send_seq=469432 receive_seq=469432 retransmit_seq=2 srtt=0.002 rttvar=0.000 rto=0.025 ready_bytes=8 upcoming_bytes=0 freq=71999137 heater_bed: target=60 temp=60.0 pwm=0.220 sd_pos=5569560 sysload=2.02 cputime=1888.692 memavail=6297352 print_time=14478.292 buffer_time=2.855 print_stall=88 extruder: target=205 temp=205.2 pwm=0.346
Stats 714291.5: gcodein=0  mcu: mcu_awake=0.017 mcu_task_avg=0.000033 mcu_task_stddev=0.000031 bytes_write=26560633 bytes_read=3981523 bytes_retransmit=9 bytes_invalid=0 send_seq=469439 receive_seq=469439 retransmit_seq=2 srtt=0.002 rttvar=0.000 rto=0.025 ready_bytes=42 upcoming_bytes=0 freq=71999136 heater_bed: target=60 temp=59.9 pwm=0.310 sd_pos=5569676 sysload=2.02 cputime=1888.698 memavail=6281948 print_time=14478.461 buffer_time=2.022 print_stall=88 extruder: target=205 temp=205.2 pwm=0.346
Stats 714292.5: gcodein=0  mcu: mcu_awake=0.017 mcu_task_avg=0.000033 mcu_task_stddev=0.000031 bytes_write=26560947 bytes_read=3981661 bytes_retransmit=9 bytes_invalid=0 send_seq=469447 receive_seq=469447 retransmit_seq=2 srtt=0.002 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=71999134 heater_bed: target=60 temp=60.0 pwm=0.225 sd_pos=5569837 sysload=2.02 cputime=1888.705 memavail=6266308 print_time=14480.606 buffer_time=3.166 print_stall=88 extruder: target=205 temp=205.2 pwm=0.396
